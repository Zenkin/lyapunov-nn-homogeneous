# -*- coding: utf-8 -*-
"""
viz_cfg.py

Конфигурация визуализации (единый объект настроек).

Зачем нужен этот файл:
- Чтобы не держать десятки DEFAULT_* констант в viz_heatmap.py.
- Чтобы стиль графиков задавался в одном месте и был единым по проекту.
- Чтобы можно было иметь несколько "профилей" (например DEBUG / SLIDES),
  не копируя параметры вручную в каждом вызове.

Идея:
- В коде отрисовки (plot_heatmap) мы принимаем cfg: VizCfg.
- Вызов функции обычно меняет только "смысловые" вещи:
  title, labels, save_path, eq_point.
- Все параметры оформления и поведения берутся из cfg.
"""

from __future__ import annotations

from dataclasses import dataclass
from typing import Sequence, Tuple, Optional, Union

# Тип уровней для контурных линий:
# - None: использовать уровни заливки (contourf)
# - int: нарисовать заданное количество уровней
# - последовательность чисел: использовать как явный список уровней
ContourLevels = Optional[Union[int, Sequence[float]]]


@dataclass(frozen=True)
class VizCfg:
    """
    Единый набор настроек для 2D heatmap-графиков (contourf + contour + colorbar).

    Важно:
    - Это именно "стиль и поведение визуализации", а не данные.
    - В cfg не должно быть X1/X2/Z, заголовков и т.п.
      Данные и подписи передаются в plot_heatmap отдельно.
    - dataclass(frozen=True) делает конфиг неизменяемым (меньше шансов
      случайно переопределить параметр в середине скрипта).
      Если нужно изменить — создаём новый cfg (или используем replace()).
    """

    # ------------------------- Фигура и экспорт -------------------------

    # Размер фигуры (ширина, высота) в дюймах.
    # Определяет общий масштаб графика (вместе с DPI при сохранении).
    figsize: Tuple[float, float] = (6.0, 5.0)

    # Количество уровней заливки contourf.
    # Чем больше, тем более плавная цветовая шкала, но тяжелее отрисовка.
    levels: int = 50

    # Разрешение сохранённого изображения (dpi).
    # Влияет только на сохранение (fig.savefig), на экран почти не влияет.
    dpi: int = 150

    # Режим масштабирования осей:
    # "auto"  — заполняет окно (часто удобно для анализа)
    # "equal" — одинаковый масштаб по x и y (геометрически корректно)
    aspect: str = "auto"

    # Использовать ли tight_layout() для авто-подбора отступов.
    # Уменьшает риск обрезания подписей, но иногда "двигает" элементы.
    tight_layout: bool = True

    # ------------------------- Подписи осей -------------------------

    # Подпись оси X по умолчанию (если пользователь не передал xlabel).
    default_xlabel: str = "x1"

    # Подпись оси Y по умолчанию (если пользователь не передал ylabel).
    default_ylabel: str = "x2"

    # Использовать ли MathText (LaTeX-подобный синтаксис Matplotlib) для подписей.
    # Если True, подписи/заголовки будут оборачиваться в $...$ (если там нет '$').
    # Пример: "x_1" -> отображается как формула x_1.
    use_math: bool = True

    # ------------------------- Цветовая карта -------------------------

    # Цветовая карта (colormap) для заливки contourf.
    # Для полей типа dW обычно удобны дивергентные карты: "RdBu_r", "seismic", "coolwarm".
    cmap: str = "RdBu_r"

    # ------------------------- Colorbar -------------------------

    # Отступ colorbar от основной оси.
    # Меньше значение — ближе к графику.
    cbar_pad: float = 0.02

    # Масштаб colorbar.
    # 1.0 — стандартная высота, <1.0 — короче, >1.0 — выше.
    cbar_shrink: float = 1.0

    # Отступ подписи colorbar от самой шкалы.
    cbar_labelpad: int = 8

    # ------------------------- Размеры шрифтов -------------------------

    # Размер шрифта заголовка графика.
    title_fontsize: int = 12

    # Размер шрифта подписей осей.
    label_fontsize: int = 11

    # Размер шрифта числовых делений (ticks) на осях.
    tick_fontsize: int = 10

    # Размер шрифта подписи colorbar.
    cbar_fontsize: int = 11

    # ------------------------- Контурные линии (поверх заливки) -------------------------

    # Рисовать ли линии уровней поверх заливки contourf.
    show_contour_lines: bool = True

    # Уровни контурных линий:
    # - None: использовать уровни заливки (contourf.levels)
    # - int: нарисовать заданное количество линий
    # - list/tuple: явный список уровней (например [-2,-1,0,1,2])
    contour_line_levels: ContourLevels = None

    # Толщина линий контура.
    contour_linewidth: float = 0.6

    # Прозрачность линий контура (0..1).
    contour_alpha: float = 0.8

    # Цвет линий контура.
    # Можно: "black", "white", "red", "#ff0000" и т.д.
    contour_color: str = "black"

    # Подписывать ли значения на линиях контура (ax.clabel).
    show_contour_labels: bool = True

    # Размер шрифта подписей на контурных линиях.
    contour_label_fontsize: int = 9

    # Формат подписей на линиях (например "%.2f", "%.1e", "%d").
    contour_label_fmt: str = "%.2f"

    # Делать ли подписи "inline" (разрывать линию под текстом).
    contour_label_inline: bool = True

    # Доп. расстояние (в пикселях) для inline-подписей.
    # Больше значение -> подписи реже пересекаются и лучше читаются,
    # но иногда "разрывы" на линиях становятся заметнее.
    contour_label_inline_spacing: int = 10

    # ------------------------- Равновесие (маркер точки) -------------------------

    # Цвет маркера равновесия.
    eq_color: str = "black"

    # Символ маркера равновесия (matplotlib marker).
    # Часто: "o" (круг), "x", "+", "*".
    eq_marker: str = "o"

    # Размер маркера (s=...) в scatter.
    eq_size: float = 50.0

    # Цвет обводки маркера (чтобы точка читалась на любом фоне).
    # Если None или "none" -> обводка отключена.
    eq_edgecolor: str = "white"

    # Толщина обводки маркера.
    eq_linewidth: float = 0.8

    # Приоритет отрисовки (чем больше, тем "выше" над другими элементами).
    eq_zorder: int = 10

    # Подпись маркера равновесия для легенды.
    # Если в plot_heatmap eq_label=None, легенда для точки не создаётся.
    eq_label: str = "eq"

    # ------------------------- Легенда -------------------------

    # Показывать ли легенду (если есть что легендировать).
    show_legend: bool = True

    # Выносить ли легенду наружу области графика.
    # Обычно удобно, когда внутри графика не хочется занимать место.
    legend_outside: bool = False

    # Позиция легенды (loc=...) по правилам Matplotlib.
    # Часто: "upper left", "upper right", "lower left" и т.п.
    legend_loc: str = "upper left"

    # Якорная точка bbox_to_anchor для вынесенной легенды.
    # Стандартный вариант "справа сверху вне оси": (1.02, 1.0).
    legend_bbox: Tuple[float, float] = (1.02, 1.0)

    # Размер шрифта легенды.
    legend_fontsize: int = 10


# ------------------------- Готовые профили -------------------------

# Профиль "для дебага": быстро, читабельно, без лишней красоты.
VIZ_DEBUG = VizCfg(
    dpi=120,
    show_contour_labels=False,  # подписи на контурах часто мешают при дебаге
    legend_outside=False,
)

# Профиль "для слайдов": чуть крупнее шрифты и выше DPI.
VIZ_SLIDES = VizCfg(
    dpi=200,
    title_fontsize=14,
    label_fontsize=13,
    tick_fontsize=12,
    cbar_fontsize=13,
    legend_fontsize=12,
    legend_outside=True,
    contour_line_levels=20,
    legend_bbox=(-0.02, 1.2),
    figsize=(7.0, 6.0)
)
